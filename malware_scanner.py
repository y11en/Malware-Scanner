#coding=utf-8

import yara
import os
import sys

# 获取 yara 规则
def get_rules(path):

	filepath = {}
	path_walk = os.walk(path)
	index = 0

	# 遍历目录下的 yara 文件
	for path, dirs, filelist in path_walk:
		for filename in filelist:
			index += 1
			key = 'rule' + str(index)
			rupath = os.path.join(path, filename)
			filepath[key] = rupath

	yararule = yara.compile(filepaths=filepath)

	return yararule


# yara 扫描函数
def scan(rule, path):

	if os.path.isfile(path):
		filepath = path
		fp = open(filepath, 'rb')
		matches = rule.match(data=fp.read())
		if len(matches)>0:
			print('[+] ' + str(filepath) + ' --> ' + str(matches) + '\n')

	elif os.path.isdir(path):
		for path, dirs, filelist in os.walk(path):
			for filename in filelist:
				malpath = os.path.join(path, filename)
				fp = open(malpath, 'rb')
				matches = rule.match(data=fp.read())
				if len(matches)>0:
					print('[+] ' + str(malpath) + ' --> ' + str(matches) + '\n')

	fp.close()


if __name__ == '__main__':

	print("\n==========================================")
	print("\t\tMalware Scanner")
	print("==========================================\n")

	rulepath = 'yara_rules'
	malpath = sys.argv[1]
	
	yararule = get_rules(rulepath)
	
	scan(yararule, malpath)